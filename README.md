<h1 align="center">mongo-type-gen</h1>
<div align="center" dir="auto">
Define types once, reuse them everywhere!
</div>
<br/>

<div align="center" dir="auto">

[![release](https://github.com/PaulSavignano/mongo-type-gen/actions/workflows/release.yaml/badge.svg)](https://github.com/PaulSavignano/mongo-type-gen/actions/workflows/release.yaml)
[![NPM Version](https://img.shields.io/npm/v/mongo-type-gen.svg?style=flat)](https://www.npmjs.com/package/mongo-type-gen)
[![NPM Downloads](https://img.shields.io/npm/dm/mongo-type-gen.svg?style=flat)](https://npmcharts.com/compare/mongo-type-gen?minimal=true)
[![BundleSize](https://img.shields.io/bundlephobia/minzip/mongo-type-gen.svg)](https://bundlephobia.com/result?p=mongo-type-gen)
[![Patreon](https://img.shields.io/badge/patreon-support%20the%20author-blue.svg)](https://www.patreon.com/PaulSavignano)

</div>

`mongo-type-gen` is a lib for unifing your types. Define once, reuse everywhere!

- **Simple:** Short `mtg` command allows for easy generating, uploading, and downloading of types.
- **Performant:** Lightweight with very few deps and a small bundle size.

Takes a collection definition, ie `**.collection.ts`;

```ts
export default {
  indexes: [
    {
      key: { name: 1 },
      unique: true,
    },
  ],
  validator: {
    $jsonSchema: {
      bsonType: 'object',
      properties: {
        gpa: {
          bsonType: ['double'],
          description: "'gpa' must be a double if field exists",
        },
        name: {
          bsonType: 'string',
          description: "'name' must be a string and is required",
        },
        year: {
          bsonType: 'int',
          description: "'year' must be an integer in [  2017,  3017  ] and is required",
          maximum: 3017,
          minimum: 2017,
        },
      },
      required: ['major', 'name', 'year'],
      title: 'Student Object Validation',
    },
  },
};
```

And generates a `mongo.types.ts` and `mongo.sdls.ts` typing files for your Typescript types and GraphQL SDLs;

```ts
/* This file is generated by mongo-type-gen.  Do not edit */

import { ObjectId } from 'mongodb';

export enum CollectionEnum {
  students = 'students',
}

export type StudentDoc = {
  gpa?: number;
  name: string;
  year: number;
};
```

```ts
/* This file is generated by mongo-type-gen.  Do not edit */

import { gql } from 'graphql-tag';

export default gql`
  enum CollectionEnum {
    students
  }

  type StudentDoc {
    gpa: Float
    name: String!
    year: Int!
  }
`;
```

## Table of Contents

- [Motivation](#motivation)
- [Usage](#usage)
- [Config](#config)
- [Validators](#validators)

## Motivation

Working with typescript can involve some busy work. Creating all the different types associated with your data by hand is tedious and time consuming. From GraphQL SDLs, to Typescript types, to Mongo JSON schemas or Mongoose Schemas. This takes time and introduces tech debt if data is added or modified.

Let's dry this up and only define our types once. Let mongo-type-gen handle the busy work of producing the different types needed for your GraphQL app writen in Typescript.

First, let's identify the best source for types. What syntax allows us to be the most expressive ðŸ¤”.
This is where Mongo's `$jsonSchema`` validators come into play. They allow for expression of meta data that cannot be expressed in Typescript, GraphQL, or Mongoose alone. This lib uses validators as the source.

Whether you have your validators defined in your project or they live in MongoDB, we'll grab em' and generate your types and SDLs.

## Usage

To get started, add the lib to your project. You'll only need it for local dev so install it as a dev dep.

```bash
npm i -D mongo-type-gen
```

Then create some ease-of-use scripts in your package.json.

```json
{
  "scripts": {
    "gen:types": "mtg", // Root command, generate typescript and sdls from your **.collection.ts files
    "gen:types:watch": "mtg -w", // watch for file changes and re-generate types
    "download:collections": "mtg-download-collections", // download your validators and indexes from Mongo
    "upload:collections": "mtg-upload-collections", // upload your validators and indexes to Mongo
    "start": "npm run gen:types:watch & ts-node-dev ./src/index.ts" // start mtg in watch mode with your app
  }
}
```

With mongo-type-gen, you'll need Mongo JSONSchema flavor validators. You can either define these in the project and ref them in a `mtg.config.js` config file or have `mtg` download them from mongo with `mtg-download-validators`.

To see this in action, create a `mtg.config.js` config file.

```js
module.exports = {
  db: 'mongo-type-gen', // Source Mongo database
  input: '**/*.collection.*s', // glob pattern for your validator files so mtg knows how to find them
  output: {
    collections: 'src/collections',
    sdls: 'src/sdls'
    types: 'src/types', // output directory where mtg should place your generated types
  }
  uri: 'mongodb://localhost:27017', // MongoDB uri endpoint
};
```

This let's `mtg` learn where it should download or upload your validators. These validators are used to generate your data's Typescript types and GraphQL SDLs.

There is also have a watcher in play to catch any changes you make to your collection's validator or indexes so your types and Mongo remain up to date.

When downloading your collection's validator and indexes from Mongo, `mtg` will add an `isGenerated` bool to the data. This lets `mtg` keep track of how to manage your collection data. If the bool is true, `mtg` will not upload your data to Mongo as it is expecting Mongo to be the source of truth. This is useful for apps that need Mongo's types but are not responsibile to setting validators and indexes. You can switch the role by simiply removing the `isGenerated` flag from the data.

## Validators

Curious about validators? Check out Mongo's docs. Validators are awesome!
https://www.mongodb.com/docs/upcoming/core/schema-validation/#schema-validation
